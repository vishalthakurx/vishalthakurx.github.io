<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- User Management ---
    const addUserBtn = document.getElementById('add-user-btn');
    const userList = document.getElementById('user-list');
    if (addUserBtn && userList) {
        let users = JSON.parse(localStorage.getItem('admin_users') || '[]');

        addUserBtn.addEventListener('click', function() {
            openUserModal();
        });

        function openUserModal(user = null, idx = null) {
            modalTitle.textContent = user ? 'Edit User' : 'Add User';
            modalForm.innerHTML = `
                <div class="form-group">
                    <label for="user-username">Username</label>
                    <input type="text" id="user-username" required pattern="^[a-zA-Z0-9_]{4,16}$" value="${user ? user.username : ''}">
                </div>
                <div class="form-group">
                    <label for="user-role">Role</label>
                    <select id="user-role">
                        <option value="admin"${user && user.role === 'admin' ? ' selected' : ''}>Admin</option>
                        <option value="editor"${user && user.role === 'editor' ? ' selected' : ''}>Editor</option>
                        <option value="viewer"${user && user.role === 'viewer' ? ' selected' : ''}>Viewer</option>
                    </select>
                </div>
            `;
            modalOverlay.classList.remove('hidden');
            modalSaveBtn.onclick = function(e) {
                e.preventDefault();
                const username = document.getElementById('user-username').value.trim();
                const role = document.getElementById('user-role').value;
                if (!username) {
                    showToast('Please enter a username.');
                    return;
                }
                if (user) {
                    users[idx] = { username, role };
                } else {
                    users.push({ username, role });
                }
                localStorage.setItem('admin_users', JSON.stringify(users));
                renderUserList();
                closeModal();
                showToast(user ? 'User updated.' : 'User added.');
            };
        }

        function renderUserList() {
            userList.innerHTML = '';
            users.forEach((user, idx) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    ${user.username} <span style="color:#888;">(${user.role})</span>
                    <button class="btn-secondary" style="margin-left:8px;" onclick="editUser(${idx})"><i class="fa fa-edit"></i></button>
                    <button class="btn-danger" style="margin-left:4px;" onclick="deleteUser(${idx})"><i class="fa fa-trash"></i></button>
                `;
                userList.appendChild(li);
            });
            const totalUsers = document.getElementById('dashboard-total-users');
            if (totalUsers) totalUsers.textContent = users.length;
        }
        window.editUser = function(idx) {
            openUserModal(users[idx], idx);
        };
        window.deleteUser = function(idx) {
            if (confirm('Delete this user?')) {
                users.splice(idx, 1);
                localStorage.setItem('admin_users', JSON.stringify(users));
                renderUserList();
                showToast('User deleted.');
            }
        };
        renderUserList();
    }

    // --- Product Edit/Delete ---
    const productList = document.getElementById('product-list');
    if (productList) {
        let products = JSON.parse(localStorage.getItem('admin_products') || '[]');

        function renderProductList() {
            productList.innerHTML = '';
            products.forEach((product, idx) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    ${product.name} - â‚¹${product.price}
                    <button class="btn-secondary" style="margin-left:8px;" onclick="editProduct(${idx})"><i class="fa fa-edit"></i></button>
                    <button class="btn-danger" style="margin-left:4px;" onclick="deleteProduct(${idx})"><i class="fa fa-trash"></i></button>
                `;
                productList.appendChild(li);
            });
            const totalProducts = document.getElementById('dashboard-total-products');
            if (totalProducts) totalProducts.textContent = products.length;
            localStorage.setItem('admin_products', JSON.stringify(products));
        }
        window.editProduct = function(idx) {
            openProductModal(products[idx], idx);
        };
        window.deleteProduct = function(idx) {
            if (confirm('Delete this product?')) {
                products.splice(idx, 1);
                renderProductList();
                showToast('Product deleted.');
            }
        };
        renderProductList();

        function openProductModal(product = null, idx = null) {
            modalTitle.textContent = product ? 'Edit Product' : 'Add Product';
            modalForm.innerHTML = `
                <div class="form-group">
                    <label for="product-name">Name</label>
                    <input type="text" id="product-name" required value="${product ? product.name : ''}">
                </div>
                <div class="form-group">
                    <label for="product-price">Price</label>
                    <input type="number" id="product-price" required min="0" value="${product ? product.price : ''}">
                </div>
            `;
            modalOverlay.classList.remove('hidden');
            modalSaveBtn.onclick = function(e) {
                e.preventDefault();
                const name = document.getElementById('product-name').value.trim();
                const price = parseFloat(document.getElementById('product-price').value);
                if (!name || isNaN(price)) {
                    showToast('Please enter valid product details.');
                    return;
                }
                if (product && idx !== null) {
                    products[idx] = { name, price };
                } else {
                    products.push({ name, price });
                }
                renderProductList();
                closeModal();
                showToast(product ? 'Product updated.' : 'Product added.');
            };
        }
    }

    // --- Service Management ---
    const addServiceBtn = document.getElementById('add-service-btn');
    const serviceList = document.getElementById('service-list');
    if (addServiceBtn && serviceList) {
        let services = JSON.parse(localStorage.getItem('admin_services') || '[]');

        addServiceBtn.addEventListener('click', function() {
            openServiceModal();
        });

        function openServiceModal(service = null, idx = null) {
            modalTitle.textContent = service ? 'Edit Service' : 'Add Service';
            modalForm.innerHTML = `
                <div class="form-group">
                    <label for="service-name">Name</label>
                    <input type="text" id="service-name" required value="${service ? service.name : ''}">
                </div>
                <div class="form-group">
                    <label for="service-desc">Description</label>
                    <input type="text" id="service-desc" required value="${service ? service.desc : ''}">
                </div>
            `;
            modalOverlay.classList.remove('hidden');
            modalSaveBtn.onclick = function(e) {
                e.preventDefault();
                const name = document.getElementById('service-name').value.trim();
                const desc = document.getElementById('service-desc').value.trim();
                if (!name || !desc) {
                    showToast('Please enter valid service details.');
                    return;
                }
                if (service && idx !== null) {
                    services[idx] = { name, desc };
                } else {
                    services.push({ name, desc });
                }
                localStorage.setItem('admin_services', JSON.stringify(services));
                renderServiceList();
                closeModal();
                showToast(service ? 'Service updated.' : 'Service added.');
            };
        }

        function renderServiceList() {
            serviceList.innerHTML = '';
            services.forEach((service, idx) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    ${service.name} - <span style="color:#888;">${service.desc}</span>
                    <button class="btn-secondary" style="margin-left:8px;" onclick="editService(${idx})"><i class="fa fa-edit"></i></button>
                    <button class="btn-danger" style="margin-left:4px;" onclick="deleteService(${idx})"><i class="fa fa-trash"></i></button>
                `;
                serviceList.appendChild(li);
            });
        }
        window.editService = function(idx) {
            openServiceModal(services[idx], idx);
        };
        window.deleteService = function(idx) {
            if (confirm('Delete this service?')) {
                services.splice(idx, 1);
                localStorage.setItem('admin_services', JSON.stringify(services));
                renderServiceList();
                showToast('Service deleted.');
            }
        };
        renderServiceList();
    }
});
</script>

<body>
    <!-- Dashboard Summary -->
    <div id="dashboard">
        <h2>Dashboard</h2>
        <div>
            <span>Total Users: <span id="dashboard-total-users">0</span></span> |
            <span>Total Products: <span id="dashboard-total-products">0</span></span>
        </div>
    </div>

    <!-- User Management -->
    <section>
        <h3>Users</h3>
        <button id="add-user-btn" class="btn-primary">Add User</button>
        <ul id="user-list"></ul>
    </section>

    <!-- Product Management -->
    <section>
        <h3>Products</h3>
        <ul id="product-list"></ul>
    </section>

    <!-- Service Management -->
    <section>
        <h3>Services</h3>
        <button id="add-service-btn" class="btn-primary">Add Service</button>
        <ul id="service-list"></ul>
    </section>

    <!-- Modal Overlay -->
    <div id="modal-overlay" class="hidden" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;z-index:1000;">
        <div style="background:#fff;padding:24px;border-radius:8px;min-width:300px;position:relative;">
            <h4 id="modal-title"></h4>
            <form id="modal-form"></form>
            <div style="margin-top:16px;">
                <button id="modal-save-btn" class="btn-primary">Save</button>
                <button type="button" id="modal-cancel-btn" class="btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" style="position:fixed;bottom:24px;right:24px;background:#333;color:#fff;padding:12px 24px;border-radius:4px;display:none;z-index:2000;"></div>

    <script>
    // Modal and Toast helpers
    const modalOverlay = document.getElementById('modal-overlay');
    const modalTitle = document.getElementById('modal-title');
    const modalForm = document.getElementById('modal-form');
    const modalSaveBtn = document.getElementById('modal-save-btn');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');
    const toast = document.getElementById('toast');

    function closeModal() {
        modalOverlay.classList.add('hidden');
    }
    modalCancelBtn.onclick = closeModal;

    function showToast(msg) {
        toast.textContent = msg;
        toast.style.display = 'block';
        setTimeout(() => { toast.style.display = 'none'; }, 2000);
    }
    </script>
</body>
